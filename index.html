<!doctype html>
<meta charset="utf-8">

<title>caddr.org</title>
<h1>caddr.org</h1>

<p>
caddr.org is a simple service that enables the creation of content-defined cross-site services
</p>

<form method="GET" action="/">
	<input type="url" name="src" placeholder="https://caddr.org/demo.js" style="width: 300px" />
	<button type="submit">Go</button>
</form>

<script>
	async function getHash32(url){
		const base32dict = 'abcdefghijklmnopqrstuvwxyz234567';
		let n = new Uint8Array(await fetch('/demo.js').then(k => k.arrayBuffer()).then(k => crypto.subtle.digest('SHA-256', k)))
			.reduce((acc, k) => acc * 256n + BigInt(k), 0n) * 256n**3n / 32n**3n
		let res = ''
		while ((n /= 32n) !== 0n) res = base32dict[Number(n % 32n)] + res;
		return res
	}
	const srcUrl = new URLSearchParams(location.search).get('src') || "https://caddr.org/demo.js";
	if(srcUrl){
		getHash32(srcUrl).then(hash36 => {
			location.href = 'https://' + hash36 + '.caddr.org/' + 
				location.search
				.replaceAll('%3A', ':')
				.replaceAll('%2F', '/')
		})
	}
</script>