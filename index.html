<!doctype html>
<meta charset="utf-8">

<title>caddr.org</title>
<h1>caddr.org</h1>

<p>
caddr.org is a simple service that enables the creation of content-defined cross-site services
</p>

<form method="GET" action="/">
	<input type="url" name="src" placeholder="https://caddr.org/demo.js" style="width: 300px" />
	<button type="submit">Go</button>
</form>

<script>
	function baseConvertBigInt(digits, srcb, destb){
	    let val = 0n
	    srcb = BigInt(srcb)
	    destb = BigInt(destb)
	    for(let i = 0; i < digits.length; i++){
	        val = val * srcb + BigInt(digits[i])
	    }
	    let res = []
	    while(val !== 0n){
	        res.unshift(Number(val % destb))
	        val = val / destb
	    }
	    return res
	}
	function toBase32(hash){
		return baseConvertBigInt([...hash, 0, 0, 0], 256, 32).map(k => base32dict[k]).slice(0,-4).join('')
	}
	const base32dict = 'abcdefghijklmnopqrstuvwxyz234567';

	function fromBase32(str){
		return btoa(baseConvertBigInt((str + 'AAAA').split('').map(k => base32dict.indexOf(k.toLowerCase())), 32, 256).slice(0, -3)
		.map(k => String.fromCharCode(k)).join(''))
	}
	async function getHash32(url){
		const hash = new Uint8Array(await fetch(url).then(k => k.arrayBuffer()).then(k => crypto.subtle.digest('SHA-256', k)));
		return toBase32(hash)
	}
	const srcUrl = new URLSearchParams(location.search).get('src');
	if(srcUrl){
		getHash32(srcUrl).then(hash36 => {
			location.href = 'https://' + hash36 + '.caddr.org/?src=' + 
				encodeURIComponent(srcUrl)
				.replaceAll('%3A', ':')
				.replaceAll('%2F', '/')
		})
	}
</script>